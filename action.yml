name: 'Check Unit Test Cases Quality'
description: 'Analyze unit test quality against JIRA requirements and generate comprehensive reports'
author: 'Vishal Gupta'

branding:
  icon: 'check-circle'
  color: 'green'

inputs:
  jira_url:
    description: 'JIRA instance URL'
    required: true
  jira_email:
    description: 'JIRA user email'
    required: true
  jira_api_token:
    description: 'JIRA API token'
    required: true
  jira_ticket_id:
    description: 'JIRA ticket ID to analyze (e.g., BB-15690)'
    required: true
  jira_project_key:
    description: 'JIRA project key'
    required: true
  confluence_url:
    description: 'Confluence instance URL'
    required: true
  confluence_email:
    description: 'Confluence user email'
    required: true
  confluence_api_token:
    description: 'Confluence API token'
    required: true
  confluence_space_key:
    description: 'Confluence space key'
    required: true
  confluence_silent_mode:
    description: 'Suppress logging during Confluence page downloads (true/false)'
    required: false
    default: 'true'
  current_analysis_path:
    description: 'Specific analysis folder to use (optional, auto-generated if not provided)'
    required: false
    default: ''
  repository_url:
    description: 'Repository URL to clone for test analysis'
    required: true
  repository_branch:
    description: 'Branch name to clone'
    required: false
    default: 'main'
  target_branch:
    description: 'Target branch for generated unit test cases (default: main)'
    required: false
    default: 'main'
  save_to_file:
    description: 'Save analysis results to files (true/false)'
    required: false
    default: 'true'
  upload_to_confluence:
    description: 'Upload results to Confluence (true/false)'
    required: false
    default: 'true'
  minimum_score:
    description: 'Minimum acceptable test quality score (0-10)'
    required: false
    default: '6.0'
  aws_region_bedrock:
    description: 'AWS region for Bedrock service'
    required: false
    default: 'us-east-2'
  aws_access_key_bedrock:
    description: 'AWS access key for Bedrock authentication'
    required: true
  aws_secret_key_bedrock:
    description: 'AWS secret key for Bedrock authentication'
    required: true
  aws_bedrock_model:
    description: 'AWS Bedrock model identifier'
    required: false
    default: 'us.anthropic.claude-3-5-sonnet-20241022-v2:0'
  anthropic_model:
    description: 'Anthropic model name for Claude'
    required: false
    default: 'sonnet[1m]'
  claude_code_use_bedrock:
    description: 'Enable AWS Bedrock for Claude (1=enabled, 0=disabled)'
    required: false
    default: '1'
  base_folder_suffix:
    description: 'Base folder suffix for organizing analysis results'
    required: false
    default: 'Generate-Unit-Tests-Via-AI'
  confluence_root_page_suffix:
    description: 'Confluence root page suffix for organizing reports'
    required: false
    default: 'Generate-Unit-Tests-Via-AI'
  confluence_upload_url:
    description: 'Confluence instance URL for uploading results (if different from fetch URL)'
    required: false
    default: ''
  confluence_upload_email:
    description: 'Confluence user email for uploading results (if different from fetch email)'
    required: false
    default: ''
  confluence_upload_api_token:
    description: 'Confluence API token for uploading results (if different from fetch token)'
    required: false
    default: ''
  confluence_upload_space_key:
    description: 'Confluence space key for uploading results (if different from fetch space)'
    required: false
    default: ''
  docker_username:
    description: 'Docker registry username for authentication (optional - required for Presidio PII detection)'
    required: false
    default: ''
  docker_password:
    description: 'Docker registry password/token for authentication (optional - required for Presidio PII detection)'
    required: false
    default: ''
  openai_api_key:
    description: 'OpenAI API key for embeddings (required if USE_POSTGRES_VECTOR_DB is enabled)'
    required: false
    default: ''

outputs:
  test_quality_score:
    description: 'Test quality score (0-10)'
    value: ${{ steps.extract_score.outputs.score }}
  analysis_path:
    description: 'Path to the analysis results folder'
    value: ${{ steps.extract_paths.outputs.analysis_path }}
  requirements_file:
    description: 'Path to the requirements file'
    value: ${{ steps.extract_paths.outputs.requirements_file }}
  result_file:
    description: 'Path to the result file'
    value: ${{ steps.extract_paths.outputs.result_file }}
  score_passed:
    description: 'Whether the score meets the minimum threshold (true/false)'
    value: ${{ steps.check_score.outputs.passed }}
  confluence_url:
    description: 'Confluence URL to the uploaded analysis report'
    value: ${{ steps.upload_confluence.outputs.confluence_url }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      shell: bash
      run: |
        cd ${{ github.action_path }}
        npm install
        npm install -g @anthropic-ai/claude-code

    - name: Docker login and start Presidio services
      if: inputs.docker_username != '' && inputs.docker_password != ''
      shell: bash
      run: |
        echo "ğŸ³ Logging in to Docker registry..."
        echo "${{ inputs.docker_password }}" | docker login -u "${{ inputs.docker_username }}" --password-stdin docker.io

        echo "ğŸ“¥ Pulling Presidio Docker images..."
        docker pull mcr.microsoft.com/presidio-analyzer:latest
        docker pull mcr.microsoft.com/presidio-anonymizer:latest

        echo "ğŸš€ Starting Presidio services..."
        docker run -d -p 5001:3000 --name presidio-anonymizer mcr.microsoft.com/presidio-anonymizer:latest
        docker run -d -p 5002:3000 --name presidio-analyzer mcr.microsoft.com/presidio-analyzer:latest

        echo "â³ Waiting for services to be ready..."
        sleep 10

        echo "âœ… Presidio services started successfully"
        docker ps | grep presidio

    - name: Skip Presidio setup notification
      if: inputs.docker_username == '' || inputs.docker_password == ''
      shell: bash
      run: |
        echo "âš ï¸  Skipping Docker login and Presidio setup"
        echo "   Docker credentials not provided - PII detection will be disabled"
        echo "   To enable Presidio services, provide docker_username and docker_password inputs"

    - name: Clone repository for analysis
      shell: bash
      run: |
        cd ${{ github.action_path }}
        echo "ğŸ“¥ Cloning repository for test analysis..."

        # Use head_ref for PRs (gives branch name like BB-2244), ref_name for other events
        BRANCH="${{ github.head_ref || github.ref_name }}"
        echo "Branch to clone: $BRANCH"

        mkdir -p repo
        cd repo
        git clone --depth 1 --branch "$BRANCH" --single-branch https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .
        echo "âœ… Repository cloned successfully (branch: $BRANCH)"

    - name: Create .env file
      shell: bash
      run: |
        cd ${{ github.action_path }}
        cat > .env << EOF
        # Application Configuration
        NODE_ENV=production

        # JIRA Configuration
        JIRA_URL=${{ inputs.jira_url }}
        JIRA_EMAIL=${{ inputs.jira_email }}
        JIRA_API_TOKEN=${{ inputs.jira_api_token }}
        JIRA_TICKET_ID=${{ inputs.jira_ticket_id }}
        JIRA_PROJECT_KEY=${{ inputs.jira_project_key }}
        JIRA_FETCH_FIELDS=summary,description,customfield_10000
        JIRA_MAX_RESULT=100
        JIRA_FILE_NAME=Jira.md

        # Confluence Configuration (for fetching data)
        CONFLUENCE_URL=${{ inputs.confluence_url }}
        CONFLUENCE_EMAIL=${{ inputs.confluence_email }}
        CONFLUENCE_API_TOKEN=${{ inputs.confluence_api_token }}
        CONFLUENCE_SPACE_KEY=${{ inputs.confluence_space_key }}
        CONFLUENCE_SILENT_MODE=${{ inputs.confluence_silent_mode }}
        CONFLUENCE_MAX_PAGES=
        CONFLUENCE_PAGE_LIMIT=50
        CONFLUENCE_FILE_NAME=Confluence.md
        CONFLUENCE_RAG_FILE_NAME=Confluence-Rag.md

        # Confluence Upload Configuration (for uploading results)
        CONFLUENCE_UPLOAD_URL=${{ inputs.confluence_upload_url }}
        CONFLUENCE_UPLOAD_EMAIL=${{ inputs.confluence_upload_email }}
        CONFLUENCE_UPLOAD_API_TOKEN=${{ inputs.confluence_upload_api_token }}
        CONFLUENCE_UPLOAD_SPACE_KEY=${{ inputs.confluence_upload_space_key }}

        # Docker Configuration
        DOCKER_USERNAME=${{ inputs.docker_username }}
        DOCKER_PASSWORD=${{ inputs.docker_password }}

        # Presidio Configuration (PII Detection)
        PRESIDIO_ANALYZE_URL=http://localhost:5002/analyze
        PRESIDIO_ANONYMIZE_URL=http://localhost:5001/anonymize

        # Data Sanitization Configuration
        SANITIZE_PG_DATA=false

        # Analysis Configuration
        CURRENT_ANALYSIS_PATH=$(echo $(date +'%Y%m%d-%H-%M-%S')-Via-AI)
        SAVE_TO_FILE=${{ inputs.save_to_file }}

        # File Names Configuration
        REQUIREMENTS_FILE_NAME=Requirements.md
        ANALYSIS_REPORT_FILE_NAME=AnalysisReport.md

        # Folder Naming Configuration
        BASE_FOLDER_SUFFIX=${{ inputs.base_folder_suffix }}
        TICKET_FOLDER_SUFFIX=Via-AI
        TIMESTAMP_FOLDER_SUFFIX=Via-AI

        # Confluence Page Names Configuration
        CONFLUENCE_ROOT_PAGE_SUFFIX=${{ inputs.confluence_root_page_suffix }}
        CONFLUENCE_TICKET_PAGE_SUFFIX=Via-AI

        # RAG System Configuration (PostgreSQL + pgvector)
        USE_POSTGRES_VECTOR_DB=false
        DATABASE_HOST=localhost
        DATABASE_PORT=5432
        DATABASE_NAME=
        DATABASE_USER=
        DATABASE_PASSWORD=

        # OpenAI Embeddings Configuration
        EMBEDDING_PROVIDER=openai
        OPENAI_API_KEY=${{ inputs.openai_api_key }}

        # Performance Configuration
        EMBEDDING_CONCURRENCY=50
        INDEXER_BATCH_SIZE=50
        CHUNK_SIZE=1000
        CHUNK_OVERLAP=200
        
        EOF
        echo "âœ… Environment configuration created"

    - name: Step 1 - Fetch JIRA and Confluence data
      shell: bash
      run: |
        cd ${{ github.action_path }}
        echo "ğŸ”„ Fetching JIRA ticket and Confluence pages..."
        npm run start
        echo "âœ… Data fetched successfully"

    - name: Step 2 - Create Requirements document
      if: inputs.claude_code_use_bedrock == '1'
      shell: bash
      env:
        CLAUDE_CODE_USE_BEDROCK:  "1"
        AWS_REGION:               ${{ inputs.aws_region_bedrock }}
        ANTHROPIC_MODEL:          ${{ inputs.anthropic_model }}
        AWS_ACCESS_KEY_ID:        ${{ inputs.aws_access_key_bedrock }}
        AWS_SECRET_ACCESS_KEY:    ${{ inputs.aws_secret_key_bedrock }}
        CLAUDE_VERBOSE_MODE:      "true"
      run: |
        cd ${{ github.action_path }}
        echo "ğŸ“‹ Creating requirements document from JIRA and Confluence..."
        npm run create-requirement-doc
        echo "âœ… Requirements document created"

        echo "ğŸ” Generating unit test cases..."
        npm run generate-unit-testcases
        echo "âœ… Unit test cases generated successfully"

    - name: Step 3 - Commit and Push Generated Tests
      id: commit_tests
      shell: bash
      run: |
        cd ${{ github.action_path }}/repo
        echo "ğŸ“ Committing all changes..."

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create branch name from ticket ID
        BRANCH_NAME="${{ inputs.jira_ticket_id }}-via-ai-$(date +%Y-%m-%d-%H-%M-%S)"
        echo "Preparing branch: $BRANCH_NAME"

        # Delete branch if it exists on remote
        if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
          echo "âŒ Branch exists on remote, deleting it..."
          git push origin --delete "$BRANCH_NAME" || echo "Failed to delete remote branch, continuing..."
        fi

        # Create new branch
        echo "Creating new branch: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"
        
        # Add all changes
        git add .
        
        # Commit all changes
        git commit -m "test: generate unit tests for ${{ inputs.jira_ticket_id }}

        Generated comprehensive unit test cases using AI based on JIRA requirements and Confluence documentation.

        JIRA Ticket: ${{ inputs.jira_ticket_id }}
        Target Branch: ${{ inputs.target_branch }}

        ğŸ¤– Generated via GitHub Actions"

        # Push to remote
        echo "â¬†ï¸  Pushing branch to remote..."
        git push -u origin "$BRANCH_NAME"

        # Generate branch URL
        BRANCH_URL="https://github.com/${{ github.repository }}/tree/$BRANCH_NAME"

        echo "âœ… All changes committed and pushed to branch: $BRANCH_NAME"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "branch_url=$BRANCH_URL" >> $GITHUB_OUTPUT
        echo "has_changes=true" >> $GITHUB_OUTPUT

    - name: Step 4 - Upload to Confluence with Branch URL
      id: upload_confluence
      shell: bash
      env:
        BRANCH_URL: ${{ steps.commit_tests.outputs.branch_url }}
        BRANCH_NAME: ${{ steps.commit_tests.outputs.branch_name }}
      run: |
        cd ${{ github.action_path }}
        echo "ğŸ“¤ Uploading results to Confluence with branch URL..."

        # Pass branch URL as environment variable to the upload script
        OUTPUT=$(npm run upload-requirements 2>&1)
        echo "$OUTPUT"

        # Extract Confluence URL from output
        CONFLUENCE_URL="${{ inputs.confluence_url }}/wiki$(echo "$OUTPUT" | grep -oP 'URL: \K.*' | head -1)"

        if [ -n "$CONFLUENCE_URL" ]; then
          echo "confluence_url=$CONFLUENCE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Results uploaded to Confluence: $CONFLUENCE_URL"
          echo "âœ… Branch link included: ${{ steps.commit_tests.outputs.branch_url }}"
        else
          echo "confluence_url=" >> $GITHUB_OUTPUT
          echo "âœ… Results uploaded to Confluence"
        fi

    - name: Step 5 - Generate Final Report
      shell: bash
      run: |
        echo "=================================================="
        echo "         ğŸ‰ UNIT TEST GENERATION COMPLETE"
        echo "=================================================="
        echo ""
        echo "ğŸ“‹ JIRA Ticket: ${{ inputs.jira_ticket_id }}"
        echo "ğŸ”— JIRA Link: ${{ inputs.jira_url }}/browse/${{ inputs.jira_ticket_id }}"
        echo ""
        echo "ğŸ“„ Confluence Documentation:"
        echo "   ${{ steps.upload_confluence.outputs.confluence_url }}"
        echo ""
        echo "ğŸŒ¿ Generated Branch:"
        echo "   Name: ${{ steps.commit_tests.outputs.branch_name }}"
        echo "   URL: ${{ steps.commit_tests.outputs.branch_url }}"
        echo ""
        echo "ğŸ“ Next Steps:"
        echo "   1. Review the generated tests in the branch"
        echo "   2. Create a Pull Request manually if needed"
        echo "   3. Check Confluence for detailed analysis report"
        echo ""
        echo "=================================================="
        echo "         âœ… All tasks completed successfully!"
        echo "=================================================="
