# Application Configuration
NODE_ENV=development

# JIRA Configuration (Input - for fetching data)
JIRA_URL=https://your-jira-instance.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your-jira-api-token
JIRA_PROJECT_KEY=YOUR_PROJECT_KEY
JIRA_FETCH_FIELDS=summary,description,customfield_10000
JIRA_MAX_RESULT=100
JIRA_TICKET_ID=

# Confluence Configuration (for fetching data)
CONFLUENCE_URL=https://your-jira-instance.atlassian.net
CONFLUENCE_EMAIL=your-email@example.com
CONFLUENCE_API_TOKEN=your-confluence-api-token
CONFLUENCE_SPACE_KEY=MySpace
CONFLUENCE_MAX_PAGES=
CONFLUENCE_PAGE_LIMIT=50
# Suppress logging during page downloads (true/false, default: false)
CONFLUENCE_SILENT_MODE=false

# Claude Runner Configuration
# Enable verbose mode for claude-runner.ts (true/false, default: false)
CLAUDE_VERBOSE_MODE=false

# Confluence Upload Configuration (optional - for uploading to different account)
# If not provided, will use the same account as above
CONFLUENCE_UPLOAD_URL=
CONFLUENCE_UPLOAD_EMAIL=
CONFLUENCE_UPLOAD_API_TOKEN=
CONFLUENCE_UPLOAD_SPACE_KEY=

# Docker Configuration
# Docker registry credentials for authentication
DOCKER_USERNAME=your-docker-username
DOCKER_PASSWORD=your-docker-password-or-token

# Presidio Configuration (PII Detection)
PRESIDIO_ANALYZE_URL=http://localhost:5002/analyze
PRESIDIO_ANONYMIZE_URL=http://localhost:5001/anonymize

# Data Sanitization Configuration
# Enable/disable PII detection and redaction for PostgreSQL data (true/false, default: true)
SANITIZE_PG_DATA=true

# Analysis Path Configuration
# Current analysis folder path (format: YYYY-MM-DD-HH-MM-SS-Via-AI)
# This is used to construct the full analysis path: {SPACE_KEY}-Quality-Check-Via-AI/{TICKET_ID}-Via-AI/{CURRENT_ANALYSIS_PATH}
CURRENT_ANALYSIS_PATH=

# Analysis folder full path (auto-generated from SPACE_KEY-BASE_FOLDER_SUFFIX/CURRENT_ANALYSIS_PATH)
# Used in Claude prompts for file reading
ANALYSIS_FOLDER=

SAVE_TO_FILE=true

# File Names Configuration (can be overridden)
JIRA_FILE_NAME=Jira.md
CONFLUENCE_FILE_NAME=Confluence.md
CONFLUENCE_RAG_FILE_NAME=Confluence-Rag.md
REQUIREMENTS_FILE_NAME=Requirements.md
ANALYSIS_REPORT_FILE_NAME=AnalysisReport.md

# Folder Naming Configuration
# Base folder suffix (default: Quality-Check-Via-AI)
BASE_FOLDER_SUFFIX=Quality-Check-Via-AI
# Ticket folder suffix (default: Via-AI)
TICKET_FOLDER_SUFFIX=Via-AI
# Timestamp folder suffix (default: Via-AI)
TIMESTAMP_FOLDER_SUFFIX=Via-AI

# Confluence Page Names Configuration
# Root page suffix (default: Generate-Unit-Tests-Via-AI)
CONFLUENCE_ROOT_PAGE_SUFFIX=Generate-Unit-Tests-Via-AI
# Ticket page suffix (default: UT-Via-AI)
CONFLUENCE_TICKET_PAGE_SUFFIX=UT-Via-AI
# Timestamp page suffix (default: UT-Via-AI)
CONFLUENCE_TIMESTAMP_PAGE_SUFFIX=UT-Via-AI

# Note: Confluence page hierarchy structure (3 levels):
# 1. Root: {SPACE_KEY}-Generate-Unit-Tests-Via-AI (e.g., BB-Generate-Unit-Tests-Via-AI)
# 2. Ticket: {TICKET_ID}-UT-Via-AI (e.g., BB-18265-UT-Via-AI)
# 3. Analysis: {YYYY-MM-DD-HH-MM-SS}-UT-Via-AI (e.g., 2025-11-13-19-26-55-UT-Via-AI)
#
# Pages matching the above patterns or timestamp format will be automatically excluded
# when downloading Confluence content to prevent AI-generated reports from being
# re-analyzed in subsequent runs (prevents feedback loops)

# ===================================================================
# RAG SYSTEM CONFIGURATION (PostgreSQL + pgvector)
# ===================================================================

# Enable PostgreSQL Vector DB for storing Confluence documents
# Set to true to save Confluence pages to PostgreSQL with embeddings during fetch
# Set to false to only save to local files (default behavior)
USE_POSTGRES_VECTOR_DB=false

# Check PostgreSQL before fetching Confluence data
# If true, check if non-expired records exist for the project_key before fetching from Confluence
# If records exist, skip Confluence fetch and chunking to avoid unnecessary API calls
# Set to false to always fetch from Confluence (default: true)
CHECK_PG_BEFORE_CONFLUENCE_FETCH=true

# PostgreSQL Database Configuration
DATABASE_HOST=localhost
DATABASE_PORT=
DATABASE_NAME=
DATABASE_USER=
DATABASE_PASSWORD=

# OpenAI Embeddings Configuration
EMBEDDING_PROVIDER=openai
OPENAI_API_KEY=

# Performance Configuration (Optional)
# Increase embedding concurrency for faster vector DB indexing (default: 10)
EMBEDDING_CONCURRENCY=50
# Increase batch size for processing pages (default: 10)
INDEXER_BATCH_SIZE=50
# Text chunking configuration (default: 1000/200)
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# ===================================================================
# SMART FILTERING CONFIGURATION (Cost Optimization)
# ===================================================================

# Enable smart filtering to reduce embedding costs and improve retrieval quality
# Set to true to filter Confluence pages based on Jira content analysis before embedding
# This can reduce embedding costs by 40-60% while improving accuracy
#
# HOW IT WORKS:
# 1. Extracts technical keywords from Jira ticket (title + description)
# 2. Scores each Confluence page based on keyword matching + title similarity
# 3. Keeps only top-scoring pages (most relevant to the ticket)
# 4. Sends filtered subset to embedding service (fewer API calls = lower cost)
USE_SMART_FILTER=true

# Maximum number of pages to keep after smart filtering
# Lower = faster & cheaper (fewer embeddings), Higher = more context (better accuracy)
#
# Recommended values based on total Confluence pages:
#  - <30 total pages: Set to 20 (keep most)
#  - 30-100 total pages: Set to 30 (default, balanced)
#  - 100+ total pages: Set to 40-50 (ensure coverage)
SMART_FILTER_MAX_PAGES=30

# Minimum relevance score threshold (0.0 to 1.0)
# Pages scoring below this threshold will be excluded from embedding
#
# Score calculation (weighted):
#   - Ticket ID Match (40%): Confluence page title/content contains the Jira ticket ID (STRONGEST signal)
#   - Keyword Match (30%): Technical terms from Jira found in Confluence page (PRIMARY signal)
#   - Title Similarity (20%): Jaccard similarity between Jira title and page title (IMPORTANT)
#   - Label Match (5%): Jira labels matching Confluence page labels (OPTIONAL - if available)
#   - Component Match (5%): Jira components found in page content (OPTIONAL - if available)
#
# Recommended values:
#  - 0.2: Lenient - includes more pages, less aggressive filtering
#  - 0.3: Balanced (default) - good tradeoff between cost and coverage
#  - 0.4-0.5: Strict - only highly relevant pages, maximum cost savings
SMART_FILTER_MIN_SCORE=0.3

# Enable/disable individual matching strategies
# You can fine-tune which signals to use for relevance scoring
#
# NOTE: Ticket ID matching (40% weight) is ALWAYS enabled - if a page contains the Jira ticket ID, it's scored highest
#
# SMART_FILTER_USE_KEYWORDS: Extract and match technical terms from Jira content (PRIMARY - 30% weight)
# SMART_FILTER_USE_TITLE: Calculate similarity between Jira and Confluence titles (IMPORTANT - 20% weight)
# SMART_FILTER_USE_LABELS: Match Confluence labels with Jira labels (OPTIONAL - 5% weight, only if Jira has labels)
# SMART_FILTER_USE_COMPONENTS: Match Jira components in Confluence content (OPTIONAL - 5% weight, only if Jira has components)
SMART_FILTER_USE_KEYWORDS=true
SMART_FILTER_USE_TITLE=true
SMART_FILTER_USE_LABELS=true
SMART_FILTER_USE_COMPONENTS=true

# Debug mode - log detailed filtering information
# When true, shows scoring breakdown for each page and keyword extraction details
# Useful for tuning the filter, but creates verbose output
# Set to true when testing, false in production
SMART_FILTER_DEBUG=false
