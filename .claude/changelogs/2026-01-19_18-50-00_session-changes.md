# Session Changelog - 2026-01-19 18:50:00

**Session Start**: ~17:00
**Session End**: 18:50
**Duration**: ~1 hour 50 minutes

## Summary
Fixed multiple issues with the GitHub Actions workflow including Presidio image migration to ghcr.io, PostgreSQL cache conflicts, environment variable parsing (vars vs secrets), and implemented daily cache rotation for Confluence data.

## Changes Made

### Files Modified

#### action.yml
- **Changes**:
  1. Added debug step to echo .env file content (with masked sensitive values)
  2. Updated Presidio images from `mcr.microsoft.com/*` to `ghcr.io/sourcefuse/presidio-*`
  3. Fixed PostgreSQL cache restore - added TRUNCATE before restore
  4. Changed `pg_dump` to use `--data-only` flag to avoid schema conflicts
  5. Added daily cache key with date component (`YYYY-MM-DD`)
  6. Added `cache-date` step to generate date for cache key
  7. Changed cache load condition to check file existence, not just cache-hit
  8. Updated save cache condition to use `steps.load-cache.outputs.cache_loaded`
- **Reason**: Fix cache conflicts, enable daily cache refresh, debug .env issues
- **Lines affected**: 265-282 (Presidio), 533-582 (cache), 500-506 (debug)

#### templates/generate-unit-testcases.yml
- **Changes**:
  1. Changed `jira_project_key` from `secrets.` to `vars.`
  2. Changed `confluence_space_key` from `secrets.` to `vars.`
  3. Changed `confluence_upload_space_key` from `secrets.` to `vars.`
  4. Updated comments to document these as variables, not secrets
- **Reason**: These are non-sensitive values that should be variables, not secrets. The setup-github-secrets.sh script creates them as variables.
- **Lines affected**: 24-30 (comments), 114, 118, 122

#### templates/check-unit-testcases.yml
- **Changes**:
  1. Reverted `jira_project_key` to use `vars.` instead of `secrets.`
  2. Reverted `confluence_space_key` to use `vars.` instead of `secrets.`
- **Reason**: Consistency with generate template and setup script
- **Lines affected**: 145, 149

#### GITHUB_CONFIGURATION.json
- **Changes**:
  1. Restored `JIRA_PROJECT_KEY`, `CONFLUENCE_SPACE_KEY`, `CONFLUENCE_UPLOAD_SPACE_KEY` to `variables.optional` section
  2. Removed these from `secrets.required` section (was added temporarily)
- **Reason**: These are non-sensitive public identifiers
- **Lines affected**: 200-227

### Commands Executed

```bash
# Commit and push Presidio image changes
git add action.yml && git commit -m "fix(action): add .env debug output and use ghcr.io Presidio images"
git push && git tag -f UT-V2.0 && git push origin UT-V2.0 --force
# Result: Commit 9c01a6f

# Revert vars to secrets changes
git add templates/*.yml && git commit -m "fix(templates): revert project/space keys from secrets to vars"
git push && git tag -f UT-V2.0 && git push origin UT-V2.0 --force
# Result: Commit d9713c6

# Fix PostgreSQL cache conflicts
git add action.yml && git commit -m "fix(cache): use data-only pg_dump to avoid schema conflicts"
git push --force && git tag -f UT-V2.0 && git push origin UT-V2.0 --force
# Result: Commit af9d3d9

# Add daily cache key
git add action.yml && git commit -m "feat(cache): add daily cache key with restore-key fallback"
git push && git tag -f UT-V2.0 && git push origin UT-V2.0 --force
# Result: Commit 826712a

# Rerun workflows
gh run rerun 21134490190 --repo sourcefuse/biz-book-ui
gh run rerun 21138406828 --repo sourcefuse/biz-book-ui
```

### Configuration Changes

- **Cache Key Format**:
  - Old: `pgvector-data-{space_key}-dim{dimensions}-v2`
  - New: `pgvector-{space_key}-dim{dimensions}-{YYYY-MM-DD}`
  - Reason: Daily cache rotation to pick up Confluence changes

- **Presidio Images**:
  - Old: `mcr.microsoft.com/presidio-analyzer:latest`, `mcr.microsoft.com/presidio-anonymizer:latest`
  - New: `ghcr.io/sourcefuse/presidio-analyzer:latest`, `ghcr.io/sourcefuse/presidio-anonymizer:latest`
  - Reason: Faster pulls from ghcr.io

## Issues Encountered

### Issue 1: PostgreSQL "relation already exists" errors
- **Problem**: When restoring from cache, `pg_dump` included schema creation statements that conflicted with Docker init scripts
- **Solution**:
  1. Changed `pg_dump` to use `--data-only` flag
  2. Added TRUNCATE before restore
  3. Used `--set ON_ERROR_STOP=off` to ignore remaining errors
- **Status**: Resolved

### Issue 2: CONFLUENCE_SPACE_KEY not being picked up
- **Problem**: Workflow failed with "Missing required environment variable: CONFLUENCE_SPACE_KEY"
- **Root Cause**: Commit b0bb7eb changed `vars.UT_GENERATE_CONFLUENCE_SPACE_KEY` to `secrets.UT_GENERATE_CONFLUENCE_SPACE_KEY`, but the setup script creates these as variables
- **Solution**: Reverted to use `vars.` for non-sensitive keys
- **Status**: Resolved

### Issue 3: Cache not refreshing with new Confluence data
- **Problem**: Old cache key was static, never refreshed
- **Solution**: Added daily date component to cache key with restore-keys fallback
- **Status**: Resolved

## Commits Made

| Hash | Message |
|------|---------|
| `9c01a6f` | fix(action): add .env debug output and use ghcr.io Presidio images |
| `d9713c6` | fix(templates): revert project/space keys from secrets to vars |
| `af9d3d9` | fix(cache): use data-only pg_dump to avoid schema conflicts |
| `826712a` | feat(cache): add daily cache key with restore-key fallback |

## Tag Updates
- `UT-V2.0` updated multiple times, final: `826712a`

## Cache Behavior Summary

| Scenario | Key | Action |
|----------|-----|--------|
| Day 1, Run 1 | `pgvector-BB-dim1536-2026-01-19` | Miss → Fetch → Save |
| Day 1, Run 2 | `pgvector-BB-dim1536-2026-01-19` | Hit → Load → Skip fetch |
| Day 2, Run 1 | `pgvector-BB-dim1536-2026-01-20` | Miss → Restore fallback → Load → Skip fetch |
| Day 2, Run 2 | `pgvector-BB-dim1536-2026-01-20` | Hit → Load → Skip fetch |

## Next Steps
- [ ] Monitor workflow run to verify all fixes work correctly
- [ ] Consider adding cache TTL input parameter for user control
- [ ] Update documentation with new cache behavior

## Notes
- User manually created variables in biz-book-ui: `UT_GENERATE_JIRA_PROJECT_KEY`, `UT_GENERATE_CONFLUENCE_SPACE_KEY`, `UT_GENERATE_CONFLUENCE_UPLOAD_SPACE_KEY`
- The Presidio images were rebuilt and pushed to ghcr.io earlier in a previous session
- Git history shows b0bb7eb introduced the vars→secrets change as part of ghcr.io migration

## Related Files
- action.yml
- templates/generate-unit-testcases.yml
- templates/check-unit-testcases.yml
- GITHUB_CONFIGURATION.json
- scripts/setup-github-secrets.sh (referenced, not modified)
- docker/pgvector/init-schema.sql (on main branch, referenced)
