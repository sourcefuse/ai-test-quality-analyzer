# Session Changelog - 2026-01-19 16:15:00

**Session Start**: ~15:30
**Session End**: 16:15
**Duration**: ~45 minutes

## Summary
Migrated Docker images from Docker Hub to GitHub Container Registry (ghcr.io) for faster pulls and cross-repository sharing. Created custom Docker images for pgvector and Presidio, pushed them to ghcr.io/sourcefuse/, and updated action.yml to use these images with GITHUB_TOKEN authentication (removing the need for Docker credentials).

## Changes Made

### Files Created

#### On Main Branch
- `docker/pgvector/Dockerfile` - Custom PostgreSQL with pgvector extension, optimized for RAG workloads
- `docker/pgvector/init-extensions.sql` - Initialize vector, uuid-ossp, pg_trgm extensions
- `docker/pgvector/init-schema.sql` - Create confluence_documents table with vector indexes
- `docker/pgvector/postgresql.conf` - PostgreSQL config optimized for vector operations
- `docker/presidio-combined/Dockerfile` - Combined Presidio Analyzer + Anonymizer in one container
- `docker/presidio-combined/analyzer_app.py` - Flask API for PII detection (port 5001)
- `docker/presidio-combined/anonymizer_app.py` - Flask API for PII anonymization (port 5002)
- `docker/presidio-combined/supervisord.conf` - Runs both Flask services
- `.github/workflows/build-docker-images.yml` - CI workflow to build and push images to ghcr.io

### Files Modified

#### action.yml
- **Changes**:
  - Replaced `docker_username` and `docker_password` inputs with single `enable_docker_services` input (default: 'true')
  - Changed Docker login from docker.io to ghcr.io using GITHUB_TOKEN
  - Changed image sources from Docker Hub to ghcr.io:
    - `ankane/pgvector:latest` → `ghcr.io/sourcefuse/pgvector-rag:latest`
    - `mcr.microsoft.com/presidio-analyzer:latest` + `presidio-anonymizer:latest` → `ghcr.io/sourcefuse/presidio-combined:latest`
  - Removed Docker image caching steps (ghcr.io is fast enough)
  - Combined 2 Presidio containers into 1
- **Reason**: Faster pulls, no Docker Hub rate limits, cross-repo sharing, simpler authentication
- **Lines affected**: 138-145 (inputs), 219-343 (Docker setup steps)

#### templates/generate-unit-testcases.yml
- **Changes**:
  - Removed `docker_username` and `docker_password` secrets from comments
  - Converted all `${{ vars.* }}` references to `${{ secrets.* }}`
  - Added `packages: read` permission for ghcr.io access
  - Set `enable_docker_services: 'true'`
- **Reason**: Simplify configuration, use secrets consistently
- **Lines affected**: 24-28 (comments), 75-78 (permissions), 109-129 (action inputs)

#### GITHUB_CONFIGURATION.json
- **Changes**: Replaced `docker_username` and `docker_password` with `enable_docker_services: "true"`
- **Reason**: Match new action.yml inputs
- **Lines affected**: 319-320

#### scripts/setup-glm-migration.sh
- **Changes**: Added removal of `UT_GENERATE_DOCKER_USERNAME` and `UT_GENERATE_DOCKER_PASSWORD` secrets
- **Reason**: These secrets are no longer needed
- **Lines affected**: 170-188 (new removal code), 207-209 (summary)

### Commands Executed

```bash
# Login to GitHub Container Registry
docker login ghcr.io -u sfvishalgupta
# Result: Successful after creating PAT with write:packages scope and SSO authorization

# Build presidio-combined image
docker build -t ghcr.io/sourcefuse/presidio-combined:latest ./docker/presidio-combined
# Result: Success (used official MS presidio-analyzer as base to avoid SSL issues)

# Build pgvector-rag image
docker build -t ghcr.io/sourcefuse/pgvector-rag:latest ./docker/pgvector
# Result: Success

# Push images to ghcr.io
docker push ghcr.io/sourcefuse/presidio-combined:latest
docker push ghcr.io/sourcefuse/pgvector-rag:latest
# Result: Success after SSO authorization

# Copy docker files to main branch
cp -r docker/ .github/workflows/build-docker-images.yml /worktrees/main/
# Result: Success

# Commit to main branch
git commit -m "feat(docker): add custom Docker images for ghcr.io"
git push
# Result: Commit 74b46d4

# Commit to GenerateUnitTestCases branch
git commit -m "feat(docker): migrate to ghcr.io and simplify Docker config"
git push
# Result: Commit b0bb7eb

# Remove docker files from GenerateUnitTestCases (already on main)
git rm -r docker/ .github/workflows/build-docker-images.yml
git commit -m "chore: remove docker files (already on main branch)"
git push
# Result: Commit 5728a14

# Update tag
git tag -f UT-V2.0 && git push origin UT-V2.0 --force
# Result: Tag updated to 5728a14
```

### Docker Images Published

| Image | Registry | Size |
|-------|----------|------|
| `ghcr.io/sourcefuse/presidio-combined:latest` | ghcr.io | ~1.5GB |
| `ghcr.io/sourcefuse/pgvector-rag:latest` | ghcr.io | ~500MB |

### Configuration Changes

- **action.yml inputs**:
  - Removed: `docker_username`, `docker_password`
  - Added: `enable_docker_services` (default: 'true')

- **Secrets no longer needed**:
  - `UT_GENERATE_DOCKER_USERNAME`
  - `UT_GENERATE_DOCKER_PASSWORD`
  - `UT_QUALITY_DOCKER_USERNAME`
  - `UT_QUALITY_DOCKER_PASSWORD`

- **New secrets (converted from variables)**:
  - `UT_GENERATE_JIRA_PROJECT_KEY`
  - `UT_GENERATE_CONFLUENCE_SPACE_KEY`
  - `UT_GENERATE_CONFLUENCE_UPLOAD_SPACE_KEY`
  - `UT_GENERATE_AI_TYPE`

## Issues Encountered

### Issue 1: SSL Certificate Verification Failed
- **Problem**: Docker build failed when downloading spaCy model from GitHub due to SSL certificate errors
- **Solution**: Used official Microsoft presidio-analyzer image as base instead of building from scratch
- **Status**: Resolved

### Issue 2: ghcr.io Permission Denied
- **Problem**: `docker login ghcr.io` failed with "denied" error
- **Solution**: Created new PAT with `write:packages` scope
- **Status**: Resolved

### Issue 3: SAML SSO Enforcement
- **Problem**: `docker push` failed with "Resource protected by organization SAML enforcement"
- **Solution**: Authorized the PAT for sourcefuse organization SSO in GitHub settings
- **Status**: Resolved

## Commits Made

| Hash | Branch | Message |
|------|--------|---------|
| `74b46d4` | main | feat(docker): add custom Docker images for ghcr.io |
| `b0bb7eb` | GenerateUnitTestCases | feat(docker): migrate to ghcr.io and simplify Docker config |
| `5728a14` | GenerateUnitTestCases | chore: remove docker files (already on main branch) |

## Tag Updates
- `UT-V2.0` updated to `5728a14`

## Next Steps
- [ ] Set image visibility to Private in GitHub Packages settings
- [ ] Grant team access to private images
- [ ] Test workflow with new ghcr.io images
- [ ] Remove old Docker secrets from repositories using this action
- [ ] Add new secrets (JIRA_PROJECT_KEY, CONFLUENCE_SPACE_KEY, AI_TYPE) to repositories

## Notes
- The custom images are linked to `sourcefuse/CheckUnitTestCases` repository via LABEL in Dockerfiles
- Images will inherit visibility from the repository (private if repo is private)
- The CI workflow `build-docker-images.yml` on main branch will auto-rebuild images when docker/ files change
- `GITHUB_TOKEN` automatically has access to ghcr.io packages within the same organization

## Related Files
- action.yml
- templates/generate-unit-testcases.yml
- GITHUB_CONFIGURATION.json
- scripts/setup-glm-migration.sh
- docker/pgvector/Dockerfile (on main)
- docker/presidio-combined/Dockerfile (on main)
- .github/workflows/build-docker-images.yml (on main)
