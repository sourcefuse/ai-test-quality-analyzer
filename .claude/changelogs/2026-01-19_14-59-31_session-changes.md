# Session Changelog - 2026-01-19 14:59:31

**Session Start**: ~14:12 (continued from previous context)
**Session End**: 14:59
**Duration**: ~47 minutes

## Summary
Session focused on security hardening, performance optimization through caching, and fixing import path issues. Major improvements include script injection prevention, Docker image caching, and PostgreSQL data caching to reduce costs and speed up workflows.

## Changes Made

### Files Modified
- `action.yml`
  - **Changes**:
    - Fixed script injection vulnerabilities in 15+ steps (pass inputs via env: block)
    - Added Docker image caching (pgvector, presidio)
    - Added PostgreSQL data caching (skip Confluence re-fetch)
    - Added `embedding_dimensions` input for cache key compatibility
  - **Reason**: Security hardening, performance optimization, cost reduction

- `templates/generate-unit-testcases.yml`
  - **Changes**: Fixed script injection in 2 steps (jira_ticket_id, Display Results)
  - **Reason**: Security hardening

- `cli/fetch-and-analyze.ts`
  - **Changes**: Fixed dynamic import paths (`./src` -> `../src`)
  - **Reason**: Fix TypeScript compilation error after moving to cli/ folder

- `cli/process-jira-with-rag-search.ts`
  - **Changes**: Fixed dynamic import path (`./src` -> `../src`)
  - **Reason**: Fix TypeScript compilation error after moving to cli/ folder

- `scripts/setup-glm-migration.sh`
  - **Changes**: Added removal of unused `AWS_BEDROCK_MODEL` secret
  - **Reason**: Cleanup unused GitHub secrets

- `/worktrees/main/package.json`
  - **Changes**: Added overrides for qs and undici security fixes
  - **Reason**: Fix Dependabot vulnerabilities on main branch

### New Inputs Added (action.yml)
- `embedding_dimensions` - Vector dimensions for cache key (default: 1536)

### Caching Implementation

#### Docker Image Cache
- **Key**: `docker-images-pgvector-presidio-v1`
- **Contents**:
  - `ankane/pgvector:latest` (~500MB)
  - `mcr.microsoft.com/presidio-analyzer:latest`
  - `mcr.microsoft.com/presidio-anonymizer:latest`
- **Savings**: ~60-90s per run

#### PostgreSQL Data Cache
- **Key**: `pgvector-data-{space_key}-dim{dimensions}-v1`
- **Example**: `pgvector-data-BB-dim1536-v1`
- **Contents**: pg_dump of confluence_documents table
- **Savings**: ~$0.003 embeddings cost, ~2-3 min per run

## Issues Encountered

### Issue 1: Script injection vulnerabilities
- **Problem**: Direct `${{ inputs.* }}` interpolation in shell scripts
- **Solution**: Pass all inputs through `env:` block
- **Status**: Resolved (15+ steps fixed)

### Issue 2: Import path error after file move
- **Problem**: `cli/fetch-and-analyze.ts` had `./src/services` instead of `../src/services`
- **Solution**: Fixed dynamic import paths in 2 files
- **Status**: Resolved

### Issue 3: OpenRouter credits exhausted
- **Problem**: Embedding API returning 402 Insufficient credits
- **Solution**: Discussed options (add credits, switch to Ollama, or disable RAG)
- **Status**: Pending user action

### Issue 4: Cache key creating new cache every run
- **Problem**: Used `github.run_id` in cache key
- **Solution**: Changed to stable key with version suffix
- **Status**: Resolved

## Commits Made

| Hash | Type | Message |
|------|------|---------|
| `5aaf43b` | feat | add embedding_dimensions input for cache key compatibility |
| `5a2b728` | fix | use stable cache key for PostgreSQL data |
| `50dc472` | perf | add PostgreSQL data caching to skip Confluence re-fetch |
| `fc2eeb6` | perf | add Docker image caching for faster workflow runs |
| `23e676d` | fix | correct dynamic import paths after moving files to cli folder |
| `73043c2` | fix | prevent script injection in GitHub Actions workflow |
| `3661f97` | fix | (main branch) add overrides to fix qs and undici vulnerabilities |

## Tag Updates
- `UT-V2.0` updated multiple times to latest commit (`5aaf43b`)

## Performance Impact

| Metric | Before | After (Cached) |
|--------|--------|----------------|
| Docker pull time | ~60-90s | ~10-15s |
| Confluence fetch | Every run | Skipped |
| Embedding cost | ~$0.003/run | $0 |
| Total time | ~5-6 min | ~2-3 min |

## Security Improvements
- All user inputs now passed through environment variables
- No direct `${{ }}` interpolation in shell scripts
- Script injection vulnerability eliminated

## Next Steps
- [ ] Add OpenRouter credits or switch to Ollama for embeddings
- [ ] Test caching behavior on second workflow run
- [ ] Consider implementing Ollama as free embedding fallback

## Related Files
- action.yml
- templates/generate-unit-testcases.yml
- cli/fetch-and-analyze.ts
- cli/process-jira-with-rag-search.ts
- scripts/setup-glm-migration.sh
